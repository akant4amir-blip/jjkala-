<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>جی جی کالا - فروشگاه اینترنتی</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-red: #e6123d;
            --primary-dark: #232f3e;
            --primary-black: #131921;
            --success: #28a745;
            --warning: #ffc107;
        }
        
        .bg-primary-custom { background-color: var(--primary-black); }
        .btn-primary-custom { 
            background-color: var(--primary-red); 
            border-color: var(--primary-red); 
        }
        .btn-primary-custom:hover {
            background-color: #c81034;
            border-color: #c81034;
        }
        .text-primary-custom { color: var(--primary-red); }
        
        .hero-section {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-black) 100%);
            color: white;
            padding: 80px 0;
            margin-bottom: 50px;
        }
        
        .product-card { 
            transition: transform 0.3s, box-shadow 0.3s; 
            border: none;
            border-radius: 12px;
            overflow: hidden;
        }
        .product-card:hover { 
            transform: translateY(-8px); 
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .cart-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 380px;
            height: 100vh;
            background: white;
            transition: right 0.3s ease-in-out;
            z-index: 1050;
            box-shadow: -5px 0 25px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        
        .cart-sidebar.active { right: 0; }
        
        .product-image {
            height: 220px;
            object-fit: cover;
            transition: transform 0.3s;
        }
        
        .product-card:hover .product-image {
            transform: scale(1.05);
        }
        
        .checkout-page {
            display: none;
            max-width: 900px;
            margin: 30px auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.1);
        }
        
        .payment-methods {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 25px 0;
        }
        
        .payment-method {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        
        .payment-method:hover {
            border-color: #dee2e6;
            background: white;
        }
        
        .payment-method.selected {
            border-color: var(--primary-red);
            background: #fff5f5;
            box-shadow: 0 5px 15px rgba(230, 18, 61, 0.1);
        }
        
        .payment-success {
            text-align: center;
            padding: 50px 30px;
            display: none;
        }
        
        .success-icon {
            font-size: 80px;
            color: var(--success);
            margin-bottom: 25px;
        }
        
        .bank-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin: 25px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .tracking-code-section {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
            text-align: center;
        }
        
        .tracking-input {
            font-family: 'Courier New', monospace;
            font-size: 18px;
            font-weight: bold;
            letter-spacing: 2px;
            text-align: center;
            border: 2px solid #e9ecef;
            border-radius: 8px;
        }
        
        .sms-timer {
            color: var(--primary-red);
            font-weight: bold;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1040;
        }
        
        .overlay.active {
            display: block;
        }
        
        .category-filter {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .category-btn {
            border: 2px solid #dee2e6;
            border-radius: 25px;
            padding: 8px 20px;
            margin: 5px;
            transition: all 0.3s;
            background: white;
        }
        
        .category-btn.active, .category-btn:hover {
            border-color: var(--primary-red);
            background: var(--primary-red);
            color: white;
        }
        
        .stock-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 2;
        }
        
        .featured-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 2;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #000;
            font-weight: bold;
        }
        
        .search-box {
            max-width: 500px;
        }
        
        .cart-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--primary-red);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <!-- نوار ناوبری -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary-custom shadow-sm sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold fs-3" href="index.html">
                <i class="fas fa-shopping-bag me-2"></i>
                <span class="text-warning">جی جی</span>کالا
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <form class="d-flex mx-auto search-box">
                    <div class="input-group">
                        <input class="form-control" type="search" id="searchInput" 
                               placeholder="جستجوی محصولات... (نام، دسته‌بندی، توضیحات)" 
                               onkeyup="handleSearch()">
                        <button class="btn btn-outline-light" type="button" onclick="performSearch()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </form>

                <div class="navbar-nav">
                    <a class="nav-link" href="admin.html" target="_blank">
                        <i class="fas fa-cog me-1"></i> مدیریت
                    </a>
                    <a class="nav-link position-relative" href="#" onclick="openCart()">
                        <i class="fas fa-shopping-cart"></i>
                        سبد خرید
                        <span class="cart-badge" id="cartBadge">0</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- بخش هیرو -->
    <section class="hero-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-6">
                    <h1 class="display-5 fw-bold mb-4">به فروشگاه اینترنتی <span class="text-warning">جی جی کالا</span> خوش آمدید</h1>
                    <p class="lead mb-4">با بهترین قیمت‌ها و کیفیت عالی در خدمت شما هستیم. تحویل سریع در سراسر کشور</p>
                    <div class="d-flex gap-3">
                        <button class="btn btn-warning btn-lg fw-bold" onclick="scrollToProducts()">
                            <i class="fas fa-shopping-bag me-2"></i>مشاهده محصولات
                        </button>
                        <button class="btn btn-outline-light btn-lg" onclick="openCart()">
                            <i class="fas fa-cart-plus me-2"></i>سبد خرید
                        </button>
                    </div>
                </div>
                <div class="col-lg-6 text-center">
                    <i class="fas fa-store fa-10x text-warning opacity-25"></i>
                </div>
            </div>
        </div>
    </section>

    <!-- فیلتر دسته‌بندی -->
    <div class="container">
        <div class="category-filter">
            <h5 class="fw-bold mb-3"><i class="fas fa-filter me-2"></i>فیلتر بر اساس دسته‌بندی</h5>
            <div class="d-flex flex-wrap" id="categoryFilters">
                <!-- دسته‌بندی‌ها با JavaScript پر می‌شوند -->
            </div>
        </div>
    </div>

    <!-- بخش محصولات -->
    <div class="container my-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold" id="productsTitle">
                <i class="fas fa-boxes me-2 text-primary-custom"></i>
                همه محصولات
            </h2>
            <div class="text-muted">
                <span id="productsCount">0</span> محصول
            </div>
        </div>

        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner-border text-primary-custom" role="status">
                <span class="visually-hidden">در حال بارگذاری...</span>
            </div>
            <p class="mt-3 text-muted">در حال بارگذاری محصولات...</p>
        </div>

        <div class="empty-state" id="emptyState" style="display: none;">
            <i class="fas fa-inbox"></i>
            <h4 class="mb-3">محصولی یافت نشد</h4>
            <p class="text-muted">هیچ محصولی مطابق با جستجوی شما وجود ندارد.</p>
            <button class="btn btn-primary-custom" onclick="clearSearch()">
                <i class="fas fa-times me-2"></i>حذف فیلترها
            </button>
        </div>

        <div class="row g-4" id="productsGrid">
            <!-- محصولات با JavaScript پر می‌شوند -->
        </div>
    </div>

    <!-- سبد خرید -->
    <div class="cart-sidebar" id="cartSidebar">
        <div class="p-4 h-100 d-flex flex-column">
            <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
                <h4 class="fw-bold mb-0">
                    <i class="fas fa-shopping-cart me-2 text-primary-custom"></i>
                    سبد خرید شما
                </h4>
                <button class="btn btn-sm btn-outline-secondary" onclick="closeCart()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="flex-grow-1 overflow-auto" id="cartItems">
                <!-- آیتم‌های سبد خرید -->
            </div>
            
            <div class="border-top pt-3 mt-auto">
                <div class="d-flex justify-content-between mb-3">
                    <strong class="fs-5">جمع کل:</strong>
                    <strong class="fs-5 text-success" id="cartTotal">۰ تومان</strong>
                </div>
                <button class="btn btn-primary-custom w-100 btn-lg" onclick="showCheckoutPage()">
                    <i class="fas fa-credit-card me-2"></i>ادامه فرآیند خرید
                </button>
                <button class="btn btn-outline-secondary w-100 mt-2" onclick="clearCart()">
                    <i class="fas fa-trash me-2"></i>خالی کردن سبد
                </button>
            </div>
        </div>
    </div>

    <!-- صفحه پرداخت -->
    <div class="checkout-page" id="checkoutPage">
        <button class="btn btn-outline-secondary mb-4" onclick="backToCart()">
            <i class="fas fa-arrow-right me-2"></i> بازگشت به سبد خرید
        </button>
        
        <h2 class="text-center mb-4 fw-bold">
            <i class="fas fa-credit-card me-2 text-primary-custom"></i>
            تکمیل اطلاعات خرید
        </h2>
        
        <form id="checkoutForm">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">نام *</label>
                    <input type="text" class="form-control" id="firstName" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">نام خانوادگی *</label>
                    <input type="text" class="form-control" id="lastName" required>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">شماره تماس *</label>
                <input type="tel" class="form-control" id="phone" 
                       placeholder="09xxxxxxxxx" pattern="09[0-9]{9}" required>
                <div class="form-text">شماره تماس باید با 09 شروع شود و 11 رقمی باشد</div>
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">آدرس کامل *</label>
                <textarea class="form-control" id="address" rows="3" 
                          placeholder="استان، شهر، خیابان، پلاک، واحد..." required></textarea>
            </div>
            
            <div class="mb-4 p-4 bg-light rounded">
                <h5 class="fw-bold mb-3">
                    <i class="fas fa-receipt me-2"></i>خلاصه سفارش
                </h5>
                <div class="d-flex justify-content-between align-items-center">
                    <span class="fs-6">مبلغ قابل پرداخت:</span>
                    <strong class="fs-4 text-success" id="checkoutTotal">۰ تومان</strong>
                </div>
                <div class="mt-2 text-muted small" id="orderItemsCount">
                    <!-- تعداد آیتم‌ها -->
                </div>
            </div>
            
            <h4 class="mt-4 mb-3 fw-bold">
                <i class="fas fa-wallet me-2"></i>روش پرداخت
            </h4>
            
            <div class="payment-methods">
                <div class="payment-method" id="cardPayment" onclick="selectPayment('card')">
                    <div class="payment-icon mb-3">
                        <i class="far fa-credit-card fa-3x text-primary"></i>
                    </div>
                    <div class="fw-bold">پرداخت آنلاین</div>
                    <small class="text-muted">پرداخت امن از طریق درگاه بانکی</small>
                </div>
                
                <div class="payment-method" id="cashPayment" onclick="selectPayment('cash')">
                    <div class="payment-icon mb-3">
                        <i class="fas fa-money-bill-wave fa-3x text-success"></i>
                    </div>
                    <div class="fw-bold">پرداخت در محل</div>
                    <small class="text-muted">پرداخت نقدی هنگام تحویل کالا</small>
                </div>
            </div>
            
            <!-- اطلاعات کارت بانکی -->
            <div class="bank-card" id="bankCardInfo" style="display: none;">
                <h5 class="fw-bold mb-3">
                    <i class="fas fa-credit-card me-2"></i>کارت بانکی مقصد
                </h5>
                <p class="mb-2 fs-6">
                    <i class="fas fa-credit-card me-2"></i>
                    شماره کارت: <strong class="fs-5">6219 8610 1234 5678</strong>
                </p>
                <p class="mb-2 fs-6">
                    <i class="fas fa-user me-2"></i>
                    به نام: <strong class="fs-6">مرجان امانی</strong>
                </p>
                <p class="mb-0 fs-6">
                    <i class="fas fa-money-bill-wave me-2"></i>
                    مبلغ واریزی: <strong class="fs-6" id="paymentAmount">۰ تومان</strong>
                </p>
            </div>

            <!-- بخش کد رهگیری -->
            <div class="tracking-code-section" id="trackingCodeSection" style="display: none;">
                <h5 class="fw-bold mb-3">
                    <i class="fas fa-qrcode me-2"></i>کد رهگیری پرداخت
                </h5>
                <p class="text-muted mb-3">لطفاً کد رهگیری پرداخت خود را وارد کنید</p>
                
                <div class="mb-3">
                    <input type="text" class="form-control tracking-input" id="trackingCodeInput" 
                           placeholder="مثال: 123456789" maxlength="20" 
                           oninput="validateTrackingCode(this)">
                    <div class="form-text">کد رهگیری معمولاً 8 تا 16 رقم است</div>
                </div>
                
                <div class="alert alert-info" id="smsAlert">
                    <i class="fas fa-sms me-2"></i>
                    <strong>پیامک تأیید:</strong> 
                    <span id="smsTimer" class="sms-timer">کد رهگیری را وارد کنید</span>
                </div>
                
                <button type="button" class="btn btn-outline-primary w-100" onclick="verifyTrackingCode()">
                    <i class="fas fa-check-circle me-2"></i>تأیید کد رهگیری
                </button>
            </div>
            
            <button type="submit" class="btn btn-primary-custom w-100 mt-4 btn-lg" id="payBtn">
                <i class="fas fa-lock me-2"></i>پرداخت و ثبت سفارش
            </button>
        </form>
        
        <div class="payment-success" id="paymentSuccess">
            <div class="success-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3 class="fw-bold mb-3">پرداخت با موفقیت انجام شد!</h3>
            <p class="fs-5 mb-3">سفارش شما ثبت شده و به زودی ارسال خواهد شد.</p>
            <p class="text-muted mb-1">شماره پیگیری سفارش:</p>
            <p class="fs-4 fw-bold text-primary-custom mb-4" id="finalTrackingCode">JJ-1403-001</p>
            <button class="btn btn-primary-custom btn-lg mt-3" onclick="backToShop()">
                <i class="fas fa-home me-2"></i>بازگشت به فروشگاه
            </button>
        </div>
    </div>

    <!-- فوتر -->
    <footer style="background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-black) 100%); color: white; padding: 50px 0 20px; margin-top: 80px;">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 mb-4">
                    <h5 class="fw-bold mb-3">
                        <i class="fas fa-map-marker-alt me-2"></i>اطلاعات تماس
                    </h5>
                    <p><i class="fas fa-location-dot me-2"></i> آدرس: مازندران، لاویج، رییس کلا</p>
                    <p><i class="fas fa-phone me-2"></i> تلفن: ۰۹۱۹۷۰۷۴۹۴۰</p>
                    <p><i class="fas fa-envelope me-2"></i> ایمیل: info@jjkala.ir</p>
                </div>
                <div class="col-lg-4 mb-4">
                    <h5 class="fw-bold mb-3">
                        <i class="fas fa-store me-2"></i>درباره جی جی کالا
                    </h5>
                    <p>فروشگاه اینترنتی جی جی کالا با بهترین قیمت‌ها و کیفیت عالی در خدمت شماست.</p>
                    <p>تحویل سریع و تضمین کیفیت در سراسر کشور</p>
                </div>
                <div class="col-lg-4 mb-4">
                    <h5 class="fw-bold mb-3">
                        <i class="fas fa-shield-alt me-2"></i>ضمانت ما
                    </h5>
                    <p><i class="fas fa-check me-2 text-success"></i> تضمین بهترین قیمت</p>
                    <p><i class="fas fa-check me-2 text-success"></i> تضمین کیفیت کالا</p>
                    <p><i class="fas fa-check me-2 text-success"></i> تحویل سریع و به موقع</p>
                    <p><i class="fas fa-check me-2 text-success"></i> پشتیبانی 24 ساعته</p>
                </div>
            </div>
            <div class="text-center mt-4 pt-3 border-top border-secondary">
                <p class="mb-0">
                    <i class="fas fa-copyright me-2"></i>
                    کلیه حقوق متعلق به جی جی کالا می‌باشد © ۱۴۰۳
                </p>
            </div>
        </div>
    </footer>

    <!-- overlay -->
    <div class="overlay" id="overlay"></div>

    <!-- اسکریپت‌ها -->
    <script src="products.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let cart = JSON.parse(localStorage.getItem('jjkala_cart')) || [];
        let selectedPayment = '';
        let orders = JSON.parse(localStorage.getItem('jjkala_orders')) || [];
        let smsTimer = null;
        let smsCountdown = 120;
        let currentCategory = 'all';
        let currentSearchQuery = '';

        // تابع همگام‌سازی محصولات
        function syncProducts() {
            if (window.productManager) {
                window.products = window.productManager.getAllProducts();
                displayProducts();
                updateCategoryFilters();
            }
        }

        function displayProducts() {
            const grid = document.getElementById('productsGrid');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const emptyState = document.getElementById('emptyState');
            
            // نمایش اسپینر
            loadingSpinner.style.display = 'block';
            grid.innerHTML = '';
            emptyState.style.display = 'none';
            
            setTimeout(() => {
                let productsToShow = window.products;
                
                // فیلتر بر اساس دسته‌بندی
                if (currentCategory !== 'all') {
                    productsToShow = productsToShow.filter(product => product.category === currentCategory);
                }
                
                // فیلتر بر اساس جستجو
                if (currentSearchQuery) {
                    productsToShow = window.productManager.searchProducts(currentSearchQuery);
                }
                
                // به‌روزرسانی عنوان و تعداد
                document.getElementById('productsCount').textContent = productsToShow.length;
                updateProductsTitle();
                
                if (productsToShow.length === 0) {
                    loadingSpinner.style.display = 'none';
                    emptyState.style.display = 'block';
                    return;
                }
                
                grid.innerHTML = '';
                
                productsToShow.forEach(product => {
                    const col = document.createElement('div');
                    col.className = 'col-xl-3 col-lg-4 col-md-6 mb-4';
                    
                    const stockStatus = product.stock === 0 ? 'ناموجود' : product.stock < 5 ? 'آخرین موجودی' : 'موجود';
                    const stockClass = product.stock === 0 ? 'bg-danger' : product.stock < 5 ? 'bg-warning' : 'bg-success';
                    const isOutOfStock = product.stock === 0;
                    
                    let imageHtml = `
                        <div class="bg-light d-flex align-items-center justify-content-center position-relative" style="height: 220px; overflow: hidden;">
                            <i class="fas fa-box fa-4x text-muted"></i>
                    `;
                    
                    if (product.image) {
                        imageHtml = `
                            <div class="bg-light position-relative" style="height: 220px; overflow: hidden;">
                                <img src="${product.image}" class="product-image w-100" alt="${product.name}">
                        `;
                    }
                    
                    col.innerHTML = `
                        <div class="card product-card h-100">
                            ${imageHtml}
                                <span class="stock-badge badge ${stockClass}">${stockStatus}</span>
                                ${product.featured ? '<span class="featured-badge badge"><i class="fas fa-star me-1"></i>ویژه</span>' : ''}
                            </div>
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title fw-bold">${product.name}</h5>
                                <p class="card-text text-muted flex-grow-1">${product.description}</p>
                                <div class="mt-auto">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <span class="h4 text-primary-custom fw-bold mb-0">${product.price.toLocaleString()}</span>
                                        <small class="text-muted">تومان</small>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">
                                            <i class="fas fa-layer-group me-1"></i>
                                            ${product.category}
                                        </small>
                                        <small class="text-muted">
                                            <i class="fas fa-box me-1"></i>
                                            ${product.stock} عدد
                                        </small>
                                    </div>
                                    <button class="btn btn-primary-custom w-100 mt-3 ${isOutOfStock ? 'disabled' : ''}" 
                                            onclick="addToCart(${product.id})" 
                                            ${isOutOfStock ? 'disabled' : ''}>
                                        <i class="fas fa-cart-plus me-2"></i>
                                        ${isOutOfStock ? 'ناموجود' : 'افزودن به سبد'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    grid.appendChild(col);
                });
                
                loadingSpinner.style.display = 'none';
            }, 500);
        }

        function updateProductsTitle() {
            const title = document.getElementById('productsTitle');
            let titleText = 'همه محصولات';
            
            if (currentCategory !== 'all') {
                titleText = `محصولات ${currentCategory}`;
            }
            
            if (currentSearchQuery) {
                titleText = `نتایج جستجو برای "${currentSearchQuery}"`;
            }
            
            title.innerHTML = `<i class="fas fa-boxes me-2 text-primary-custom"></i>${titleText}`;
        }

        function updateCategoryFilters() {
            if (!window.productManager) return;
            
            const categories = window.productManager.getCategories();
            const filtersContainer = document.getElementById('categoryFilters');
            
            let filtersHTML = `
                <button class="category-btn ${currentCategory === 'all' ? 'active' : ''}" 
                        onclick="filterByCategory('all')">
                    <i class="fas fa-th-large me-2"></i>همه محصولات
                </button>
            `;
            
            categories.forEach(category => {
                filtersHTML += `
                    <button class="category-btn ${currentCategory === category ? 'active' : ''}" 
                            onclick="filterByCategory('${category}')">
                        <i class="fas fa-tag me-2"></i>${category}
                    </button>
                `;
            });
            
            filtersContainer.innerHTML = filtersHTML;
        }

        function filterByCategory(category) {
            currentCategory = category;
            displayProducts();
        }

        function handleSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (query === '') {
                clearSearch();
            }
        }

        function performSearch() {
            currentSearchQuery = document.getElementById('searchInput').value.trim();
            displayProducts();
        }

        function clearSearch() {
            currentSearchQuery = '';
            document.getElementById('searchInput').value = '';
            displayProducts();
        }

        function scrollToProducts() {
            document.getElementById('productsTitle').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }

        function addToCart(productId) {
            if (!window.productManager) return;
            
            const product = window.productManager.getProductById(productId);
            if (!product) return;
            
            if (product.stock === 0) {
                showAlert('این محصول در حال حاضر ناموجود است!', 'warning');
                return;
            }
            
            const existingItem = cart.find(item => item.id === productId);
            
            if (existingItem) {
                if (existingItem.quantity >= product.stock) {
                    showAlert('تعداد درخواستی بیشتر از موجودی است!', 'warning');
                    return;
                }
                existingItem.quantity++;
            } else {
                cart.push({
                    ...product,
                    quantity: 1
                });
            }
            
            updateCart();
            saveCart();
            showAlert(`"${product.name}" به سبد خرید اضافه شد!`, 'success');
        }

        function updateCart() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cartBadge').textContent = totalItems;
            
            const itemsContainer = document.getElementById('cartItems');
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            document.getElementById('cartTotal').textContent = total.toLocaleString() + ' تومان';
            
            if (cart.length === 0) {
                itemsContainer.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-shopping-cart fa-4x mb-3 opacity-25"></i>
                        <p class="mb-0">سبد خرید شما خالی است</p>
                    </div>
                `;
                return;
            }
            
            itemsContainer.innerHTML = '';
            cart.forEach(item => {
                let itemImage = '<i class="fas fa-box fa-2x text-muted"></i>';
                if (item.image) {
                    itemImage = `<img src="${item.image}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;" alt="${item.name}">`;
                }
                
                const div = document.createElement('div');
                div.className = 'd-flex justify-content-between align-items-center mb-3 p-3 border-bottom';
                div.innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="me-3">${itemImage}</div>
                        <div>
                            <div class="fw-bold">${item.name}</div>
                            <div class="text-muted small">
                                ${item.price.toLocaleString()} × ${item.quantity}
                            </div>
                            <div class="text-success fw-bold">
                                ${(item.price * item.quantity).toLocaleString()} تومان
                            </div>
                        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <button class="btn btn-sm btn-outline-secondary me-2" onclick="decreaseCartItem(${item.id})">
                            <i class="fas fa-minus"></i>
                        </button>
                        <span class="mx-2 fw-bold">${item.quantity}</span>
                        <button class="btn btn-sm btn-outline-secondary me-3" onclick="increaseCartItem(${item.id})">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${item.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                itemsContainer.appendChild(div);
            });
        }

        function increaseCartItem(productId) {
            const item = cart.find(item => item.id === productId);
            if (item) {
                const product = window.productManager.getProductById(productId);
                if (item.quantity < product.stock) {
                    item.quantity++;
                    updateCart();
                    saveCart();
                } else {
                    showAlert('تعداد درخواستی بیشتر از موجودی است!', 'warning');
                }
            }
        }

        function decreaseCartItem(productId) {
            const item = cart.find(item => item.id === productId);
            if (item && item.quantity > 1) {
                item.quantity--;
                updateCart();
                saveCart();
            } else {
                removeFromCart(productId);
            }
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            updateCart();
            saveCart();
            showAlert('محصول از سبد خرید حذف شد!', 'info');
        }

        function clearCart() {
            if (cart.length === 0) return;
            
            if (confirm('آیا از خالی کردن سبد خرید مطمئن هستید؟')) {
                cart = [];
                updateCart();
                saveCart();
                showAlert('سبد خرید خالی شد!', 'info');
            }
        }

        function openCart() {
            document.getElementById('cartSidebar').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }

        function closeCart() {
            document.getElementById('cartSidebar').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }

        function showCheckoutPage() {
            if (cart.length === 0) {
                showAlert('سبد خرید خالی است!', 'warning');
                return;
            }
            
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            
            document.getElementById('checkoutTotal').textContent = total.toLocaleString() + ' تومان';
            document.getElementById('paymentAmount').textContent = total.toLocaleString() + ' تومان';
            document.getElementById('orderItemsCount').textContent = `${totalItems} قلم کالا`;
            
            document.getElementById('checkoutPage').style.display = 'block';
            closeCart();
            
            // ریست کردن فرم
            document.getElementById('trackingCodeSection').style.display = 'none';
            document.getElementById('bankCardInfo').style.display = 'none';
            selectedPayment = '';
            document.querySelectorAll('.payment-method').forEach(pm => {
                pm.classList.remove('selected');
            });
        }

        function backToCart() {
            document.getElementById('checkoutPage').style.display = 'none';
            openCart();
            stopSmsTimer();
        }

        function backToShop() {
            document.getElementById('checkoutPage').style.display = 'none';
            document.getElementById('paymentSuccess').style.display = 'none';
            document.getElementById('checkoutForm').style.display = 'block';
            document.getElementById('checkoutForm').reset();
            stopSmsTimer();
        }

        function selectPayment(method) {
            selectedPayment = method;
            
            document.querySelectorAll('.payment-method').forEach(pm => {
                pm.classList.remove('selected');
            });
            
            if (method === 'card') {
                document.getElementById('cardPayment').classList.add('selected');
                document.getElementById('bankCardInfo').style.display = 'block';
                document.getElementById('trackingCodeSection').style.display = 'block';
                document.getElementById('payBtn').innerHTML = '<i class="fas fa-lock me-2"></i>پرداخت آنلاین';
                startSmsTimer();
            } else if (method === 'cash') {
                document.getElementById('cashPayment').classList.add('selected');
                document.getElementById('bankCardInfo').style.display = 'none';
                document.getElementById('trackingCodeSection').style.display = 'none';
                document.getElementById('payBtn').innerHTML = '<i class="fas fa-check me-2"></i>ثبت سفارش و پرداخت در محل';
                stopSmsTimer();
            }
        }

        function startSmsTimer() {
            stopSmsTimer();
            smsCountdown = 120;
            
            document.getElementById('smsTimer').textContent = 'پیامک در حال ارسال...';
            document.getElementById('smsTimer').className = 'sms-timer';
            
            smsTimer = setInterval(() => {
                smsCountdown--;
                
                if (smsCountdown > 0) {
                    const minutes = Math.floor(smsCountdown / 60);
                    const seconds = smsCountdown % 60;
                    document.getElementById('smsTimer').textContent = 
                        `پیامک تا ${minutes}:${seconds.toString().padStart(2, '0')} دیگر ارسال می‌شود`;
                } else {
                    document.getElementById('smsTimer').textContent = 'پیامک ارسال شد! کد را وارد کنید';
                    document.getElementById('smsTimer').className = 'text-success fw-bold';
                    clearInterval(smsTimer);
                }
            }, 1000);
        }

        function stopSmsTimer() {
            if (smsTimer) {
                clearInterval(smsTimer);
                smsTimer = null;
            }
        }

        function validateTrackingCode(input) {
            input.value = input.value.replace(/[^0-9]/g, '');
        }

        function verifyTrackingCode() {
            const trackingCode = document.getElementById('trackingCodeInput').value;
            
            if (!trackingCode) {
                showAlert('لطفاً کد رهگیری را وارد کنید', 'warning');
                return;
            }
            
            if (trackingCode.length < 6) {
                showAlert('کد رهگیری باید حداقل ۶ رقم باشد', 'warning');
                return;
            }
            
            document.getElementById('smsTimer').textContent = 'کد رهگیری تأیید شد ✓';
            document.getElementById('smsTimer').className = 'text-success fw-bold';
            showAlert('کد رهگیری با موفقیت تأیید شد!', 'success');
        }

        function processPayment() {
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            
            // ذخیره سفارش
            const order = {
                id: orders.length + 1,
                customerName: firstName + ' ' + lastName,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                items: [...cart],
                total: total,
                paymentMethod: selectedPayment,
                date: new Date().toLocaleDateString('fa-IR'),
                time: new Date().toLocaleTimeString('fa-IR'),
                trackingCode: 'JJ-' + (1403 + Math.floor(Math.random() * 10)) + '-' + (orders.length + 1).toString().padStart(3, '0'),
                bankTrackingCode: selectedPayment === 'card' ? document.getElementById('trackingCodeInput').value || 'ندارد' : 'پرداخت در محل',
                status: 'paid'
            };
            
            orders.push(order);
            saveOrders();
            
            // کاهش موجودی
            cart.forEach(item => {
                window.productManager.decreaseStock(item.id, item.quantity);
            });
            
            // نمایش موفقیت
            document.getElementById('finalTrackingCode').textContent = order.trackingCode;
            document.getElementById('checkoutForm').style.display = 'none';
            document.getElementById('paymentSuccess').style.display = 'block';
            
            // خالی کردن سبد خرید
            cart = [];
            updateCart();
            saveCart();
            stopSmsTimer();
            
            showAlert(`سفارش شما با شماره پیگیری ${order.trackingCode} ثبت شد!`, 'success', 5000);
        }

        function showAlert(message, type = 'info', duration = 3000) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.style.position = 'fixed';
            alert.style.top = '20px';
            alert.style.left = '50%';
            alert.style.transform = 'translateX(-50%)';
            alert.style.zIndex = '9999';
            alert.style.minWidth = '300px';
            alert.style.textAlign = 'center';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, duration);
        }

        function saveCart() {
            localStorage.setItem('jjkala_cart', JSON.stringify(cart));
        }

        function saveOrders() {
            localStorage.setItem('jjkala_orders', JSON.stringify(orders));
        }

        // فرم پرداخت
        document.getElementById('checkoutForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!selectedPayment) {
                showAlert('لطفاً روش پرداخت را انتخاب کنید', 'warning');
                return;
            }
            
            if (selectedPayment === 'card') {
                const trackingCode = document.getElementById('trackingCodeInput').value;
                if (!trackingCode) {
                    showAlert('لطفاً کد رهگیری پرداخت را وارد کنید', 'warning');
                    return;
                }
            }
            
            // شبیه‌سازی پرداخت
            showAlert('در حال پردازش پرداخت...', 'info');
            
            setTimeout(() => {
                processPayment();
            }, 2000);
        });

        // بستن با کلیک روی overlay
        document.getElementById('overlay').addEventListener('click', function() {
            closeCart();
        });

        // اجرای اولیه
        document.addEventListener('DOMContentLoaded', function() {
            displayProducts();
            updateCart();
            
            // مخفی کردن بخش‌های پرداخت در ابتدا
            document.getElementById('bankCardInfo').style.display = 'none';
            document.getElementById('trackingCodeSection').style.display = 'none';
            
            // نمایش پیام خوش‌آمدگویی
            setTimeout(() => {
                if (window.products && window.products.length > 0) {
                    showAlert(`به جی جی کالا خوش آمدید! ${window.products.length} محصول آماده خرید است.`, 'info', 4000);
                }
            }, 1000);
        });
    </script>
</body>
</html>
